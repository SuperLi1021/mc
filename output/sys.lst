C51 COMPILER V9.60.0.0   SYS                                                               08/19/2021 11:54:42 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE SYS
OBJECT MODULE PLACED IN ..\output\sys.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE ..\user\sys\sys.c OPTIMIZE(8,SPEED) BROWSE INCDIR(C:\Keil_v5\C51\INC;C:\
                    -Keil_v5\C51\INC) DEBUG OBJECTEXTEND PRINT(..\output\sys.lst) TABS(2) OBJECT(..\output\sys.obj)

line level    source

   1          /*********************************************************************/
   2          /*公司名称： 深圳市朗科智能电气股份有限公司                          */
   3          /*模 块 名： 系统模块                                                */
   4          /*创 建 人： LICHAOFAN     日期：2021-08-13                          */
   5          /*修 改 人： LICHAOFAN     日期：2021-08-13                          */
   6          /*功能描述： 提供定时，延时，信号抓取，信号处理                */
   7          /*其他说明：                                                         */
   8          /*版本：                                                             */
   9          /*********************************************************************/
  10          
  11          #include <SN8F5702.h>
  12          /********************************定义全局位变量***********************/
  13          bit PinFlag;
  14          
  15          /********************************定义全局字节变量*********************/
  16          extern unsigned int PinT;
  17          extern unsigned char Level,PinBit,SWFlag,HWFlag,sw;
  18          
  19          /*********************************************************************
  20          * 函 数 名： InitT0T1
  21          * 功能描述： 对定时器初始化
  22          * 函数说明： 定时器初始化函数
  23          * 调用函数： 
  24          * 全局变量：
  25          * 输 入： 无
  26          * 返 回： 无
  27          * 设 计 者：LICHAOFAN 日期：2021-08-13
  28          * 修 改 者：LICHAOFAN 日期：2021-08-13
  29          /*版本：
  30          /**********************************************************************/
  31          void InitT0T1(void)
  32          { 
  33   1        TH1   = 0x9b;          //装入初值
  34   1        TL1   = 0x9b;
  35   1        TH0   = 0x9B;          //装入初值
  36   1        TL0   = 0x9B;
  37   1        TMOD  = 0x66;          //使用T0 T1 自动装填模式
  38   1        TCON0 = 0x22;          //外分频控制 /32
  39   1        TCON  = 0x50;          //启动定时器T0 T1 的功能控制位
  40   1        IEN0  = 0x8A;          //使能中断
  41   1      }
  42          
  43          
  44          /*********************************************************************
  45          * 函 数 名： InitT2
  46          * 功能描述： 对定时器t2初始化
  47          * 函数说明： 定时器t2初始化函数
  48          * 调用函数： 
  49          * 全局变量：
  50          * 输 入： 无
  51          * 返 回： 无
  52          * 设 计 者：LICHAOFAN 日期：2021-08-16
  53          * 修 改 者：LICHAOFAN 日期：2021-08-16
  54          /*版本：
C51 COMPILER V9.60.0.0   SYS                                                               08/19/2021 11:54:42 PAGE 2   

  55          /**********************************************************************/
  56          void InitT2(void)
  57          { 
  58   1        TH2 = 0xE5;           //定时2.5ms
  59   1        TL2 = 0xF5;
  60   1        T2CON = 0x00;
  61   1        IEN0 |= 0xA0;         //使能T2中断
  62   1      
  63   1      }      
  64          /*********************************************************************
  65          * 函 数 名： T2Interrupt
  66          * 功能描述： 输出2.5ms低电平
  67          * 函数说明： T2中断处理函数
  68          * 调用函数： 
  69          * 全局变量：
  70          * 输 入： 无
  71          * 返 回： 无
  72          * 设 计 者：LICHAOFAN 日期：2021-08-13
  73          * 修 改 者：LICHAOFAN 日期：2021-08-13
  74          /*版本：
  75          /**********************************************************************/
  76          void T2Interrupt(void) interrupt ISRTimer2
  77          {   static bit MotorFlag;
  78   1          TH2 = 0xE5;                     //重装初值
  79   1          TL2 = 0xF5;
  80   1         
  81   1             IRCON &= 0xBF;                   // TF2清零
  82   1      
  83   1          if(MotorFlag==0)
  84   1          {       
  85   2            P05=0;                    //输出2.5ms低电平
  86   2            MotorFlag=1;
  87   2              return;
  88   2          }
  89   1            
  90   1          if(MotorFlag==1)                //输出完毕，关闭定时器2
  91   1          {
  92   2            MotorFlag=0;  
  93   2            P05=1;
  94   2            T2CON =0x00;
  95   2                return;
  96   2          }
  97   1         
  98   1      }
  99          /*********************************************************************
 100          * 函 数 名： T1Interrupt
 101          * 功能描述： 抓取信号中单个bit
 102          * 函数说明： T1中断处理函数
 103          * 调用函数： 
 104          * 全局变量： PinBit，PinFlag
 105          * 输 入： 无
 106          * 返 回： 无
 107          * 设 计 者：LICHAOFAN 日期：2021-08-13
 108          * 修 改 者：LICHAOFAN 日期：2021-08-13
 109          /*版本：
 110          /**********************************************************************/
 111          void T1Interrupt(void) interrupt ISRTimer1 
 112          {   
 113   1        /********************************定义字节变量***********************/
 114   1          static unsigned char i,PinH,PinL;
 115   1          unsigned char j,bitl,bith;
 116   1          i++;
C51 COMPILER V9.60.0.0   SYS                                                               08/19/2021 11:54:42 PAGE 3   

 117   1      
 118   1          if(i<10)                            //每100us取一次值，比较高低电平的数量
 119   1          {
 120   2          for(j=0;j<5;j++)
 121   2            { _nop_();_nop_();
 122   3            if((P0&0x10)==0X10) 
 123   3            {
 124   4                                      //取值
 125   4                bith++;
 126   4            }
 127   3            else
 128   3              bitl++;
 129   3          }
 130   2          if(bitl>bith)
 131   2          {
 132   3            PinL++;
 133   3          }
 134   2          else
 135   2            PinH++;
 136   2          bith=0;
 137   2          bitl=0;
 138   2          }
 139   1          else
 140   1          {
 141   2            i=0;
 142   2            if(PinH>PinL)                     //高电平多则该BIT为1
 143   2            {
 144   3            PinBit=1;
 145   3                //  P00=1;
 146   3              }
 147   2            else                              //反之为0
 148   2            {
 149   3              PinBit=0;
 150   3              //  P00=0;
 151   3            }
 152   2            PinH=0;                           //对计数值清零，将获取成功标志位置1，关闭定时器1
 153   2            PinL=0;
 154   2            PinFlag=1;
 155   2            TR1=0;
 156   2          }
 157   1          
 158   1         
 159   1      }
 160          /*********************************************************************
 161          * 函 数 名： T0Interrupt
 162          * 功能描述： 定时100us，抓取信号跳变，选择t1开启时间，对信号进行处理
 163          * 函数说明： T0中断处理函数
 164          * 调用函数： 
 165          * 全局变量：  PinBit，PinFlag，PinT
 166          * 输 入： 无
 167          * 返 回： 无
 168          * 设 计 者：LICHAOFAN 日期：2021-08-16
 169          * 修 改 者：LICHAOFAN 日期：2021-08-16
 170          /*版本：
 171          /**********************************************************************/
 172          void T0Interrupt(void) interrupt ISRTimer0 
 173          {   /********************************定义字节变量***********************/
 174   1          static  unsigned int PinData,DataError,PinOld,HWTimes,PinT1;
 175   1          static  unsigned char DataF,TIME,P07Old,P07Time,ZeroOld;
 176   1        unsigned char i,j,k;
 177   1          /********************************定义位变量*************************/
 178   1          static  bit P07Flag,delaytime;
C51 COMPILER V9.60.0.0   SYS                                                               08/19/2021 11:54:42 PAGE 4   

 179   1          TIME++;
 180   1          if(TIME>=100)
 181   1          {TIME=0;
 182   2          P00=~P00;}                            //模拟过零信号
 183   1      
 184   1      
 185   1      
 186   1        for(i=0;i<5;i++)
 187   1          {
 188   2          _nop_(); _nop_(); 
 189   2          if((P0&0X10)!=ZeroOld)                      //抓取p04下降沿
 190   2          {
 191   3            j++;
 192   3          }
 193   2        }
 194   1        if(j>3)
 195   1        {
 196   2          k=1;
 197   2        }
 198   1        j=0;
 199   1        
 200   1        if(k==1)                      //抓取p04下降沿
 201   1        {   k=0;
 202   2             
 203   2      
 204   2            delaytime=1;
 205   2             if((P0&0X10)==0)                               //若有则接收到红外信号，取下降沿作为触发
 206   2              {
 207   3              
 208   3                TR1=1;                          //若抓到下降沿，则打开t1定时器获取数据
 209   3                DataF++;
 210   3                    
 211   3              }
 212   2            DataError=0;                                
 213   2              ZeroOld=(P0&0x10);  
 214   2            
 215   2          }
 216   1        else if(delaytime==1)
 217   1            DataError++;   
 218   1          if(DataError==600)                        //当6ms没有收到红外信号，就认为此轮信号接收完成
 219   1          {
 220   2            //  DataError=0;                      //对计数值清零
 221   2            DataF=0;
 222   2            HWTimes++;
 223   2          }
 224   1         
 225   1          if(DataError==1500)                       //当15ms未收到红外信号，认为该次按键结束
 226   1        {   delaytime=0;
 227   2          DataError=0;
 228   2          HWFlag=1;
 229   2        }
 230   1           
 231   1           
 232   1           
 233   1           
 234   1          if(DataF>=1)                            //读取信号
 235   1          {
 236   2              
 237   2              if(PinFlag==1)                      //当有信号bit被完全获取
 238   2              { 
 239   3                      PinFlag=0;
 240   3                      PinData=(PinData<<1)+PinBit;        //记录
C51 COMPILER V9.60.0.0   SYS                                                               08/19/2021 11:54:42 PAGE 5   

 241   3                  if(DataF==12)                 //当其为最后一位时
 242   3                  {  
 243   4                      if(PinOld==PinData)           //与上一次收到的值进行比较
 244   4                      {   
 245   5                        PinFlag=0;
 246   5                           PinT1=PinData;
 247   5                            PinData=0;
 248   5                        }
 249   4                      else                  //否则记录下该值
 250   4                        PinOld=PinData;
 251   4                      PinData=0;
 252   4                          DataF=0;
 253   4                          PinFlag=0;
 254   4                          
 255   4                  } 
 256   3                  
 257   3              }
 258   2      
 259   2          }
 260   1      
 261   1          if((P2&0X01)!=P07Old)                     //抓取过零信号
 262   1          {  
 263   2            _nop_(); _nop_();
 264   2            if((P2&0X01)!=P07Old)                     //抓取过零信号
 265   2            {  
 266   3               P07Flag=1;
 267   3            
 268   3                P07Old=(P2&0x01);
 269   3              }
 270   2          }
 271   1          if(P07Flag==1)                          //当有过零时 计数加一
 272   1          {   
 273   2              P07Time++;
 274   2                    
 275   2          }
 276   1          if(P07Time>=Level)                        //当计数值大于规定值时，打开T2计时器，输出2.5ms的低电平
 277   1          {       
 278   2            if(SWFlag==1)                       //当两个开关均打开时再开启定时器2输出
 279   2                  {   
 280   3              TH2 = 0xFF;
 281   3                  TL2 = 0xFE;
 282   3                T2CON =0x01;
 283   3                        
 284   3                  }
 285   2            P07Time=0;
 286   2            P07Flag=0;
 287   2              
 288   2          }
 289   1              if(HWFlag==1)                       //当按键已经结束时，将读取的值传出去
 290   1          {
 291   2              sw=1;                         //通知主函数该次按键结束
 292   2              HWFlag=0;                       //按键结束标志
 293   2            PinT=PinT1;                       //传至主函数
 294   2                  PinT1=0x00;
 295   2          }
 296   1      
 297   1          
 298   1          
 299   1      }
 300            
 301          /*********************************************************************
 302          * 函 数 名： Delay100us
C51 COMPILER V9.60.0.0   SYS                                                               08/19/2021 11:54:42 PAGE 6   

 303          * 功能描述： 提供100us延时
 304          * 函数说明： 延时函数
 305          * 调用函数： _nop_()
 306          * 全局变量：
 307          * 输 入： unsigned int n
 308          * 返 回： 无
 309          * 设 计 者：LICHAOFAN 日期：2021-08-13
 310          * 修 改 者：LICHAOFAN 日期：2021-08-13
 311          /*版本：
 312          /**********************************************************************/
 313          void Delay100us(unsigned char n)
 314          {
 315   1          unsigned char i, j;
 316   1          i = 0;
 317   1          j = 0;
 318   1          for (i=0; i<n; i++) 
 319   1          {
 320   2              for (j=0; j<2; j++) 
 321   2              {
 322   3               _nop_(); _nop_();  _nop_(); _nop_();
 323   3             _nop_();  _nop_(); _nop_(); _nop_();
 324   3              }
 325   2          }
 326   1      }
 327          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    546    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     18       3
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      4    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
